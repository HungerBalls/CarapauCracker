# menu_exploit.py â€” CarapauCracker v2
from modules.exploit import (
    parse_nmap_services, find_exploits
)
from modules.utils import banner, log
from colorama import Fore
from pathlib import Path
from rich.panel import Panel
from rich.console import Console


def run_exploit_menu(target, run_dir, report_path, session_log):
    """Automated exploitation submenu"""
    console = Console()
    banner()
    console.print(Panel.fit(
        "[cyan]1[/cyan] - Search exploits based on last Nmap scan\n"
        "[cyan]0[/cyan] - Return",
        title="ðŸ’¥ Automated Exploitation Menu",
        border_style="cyan"
    ))

    opt = input(Fore.YELLOW + "\n[Â»] Choose an option: ").strip()
    if opt == "0":
        banner()
        return

    if opt == "1":
        nmap_file = Path(run_dir) / "report.txt"
        if not nmap_file.exists():
            log(Fore.RED + "[!] No Nmap report found. Run the scan first.", session_log)
            return
        nmap_output = nmap_file.read_text()
        services = parse_nmap_services(nmap_output)
        if not services:
            log(Fore.RED + "[!] No services identified in the report.", session_log)
            return
        find_exploits(services, report_path, session_log)
    else:
        log(Fore.RED + "[âœ˜] Invalid option.", session_log)

    input(Fore.YELLOW + "\nPress ENTER to continue...")
