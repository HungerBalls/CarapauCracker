# auto_exploit.py â€” CarapauCracker Auto-Exploitation
"""
Automatic exploitation based on discovered vulnerabilities
For CTF and authorized pentesting only
"""
from typing import List, Dict, Optional
from pathlib import Path
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from modules.utils import run_command_live, log
from modules.exploit import find_exploits
from modules.payloads import PayloadGenerator
from colorama import Fore

console = Console()


class AutoExploit:
    """Automatic exploitation engine"""
    
    def __init__(self, target: str, report_path: Path, log_file: Optional[Path] = None):
        self.target = target
        self.report_path = report_path
        self.log_file = log_file
        self.payload_gen = PayloadGenerator()
        self.exploits_found = []
    
    def analyze_services(self, services: List[Dict]) -> Dict:
        """
        Analyze services and identify exploitation opportunities
        
        Args:
            services: List of discovered services
        
        Returns:
            Dictionary with exploitation opportunities
        """
        opportunities = {
            "rce": [],
            "sqli": [],
            "xss": [],
            "command_injection": [],
            "weak_credentials": [],
            "known_vulnerabilities": []
        }
        
        for service in services:
            svc_name = service.get("service", "").lower()
            version = service.get("version", "").lower()
            port = service.get("port", "")
            
            # Check for known vulnerable services
            if "apache" in svc_name and "2.4.49" in version:
                opportunities["rce"].append({
                    "service": svc_name,
                    "port": port,
                    "vulnerability": "CVE-2021-41773",
                    "exploit": "Path traversal to RCE"
                })
            
            if "openssh" in svc_name and "7.4" in version:
                opportunities["known_vulnerabilities"].append({
                    "service": svc_name,
                    "port": port,
                    "vulnerability": "Multiple CVEs",
                    "note": "Check for specific version"
                })
            
            # Web services
            if svc_name in ["http", "https", "apache", "nginx", "iis"]:
                opportunities["sqli"].append({
                    "service": svc_name,
                    "port": port,
                    "note": "Test for SQL injection"
                })
                opportunities["xss"].append({
                    "service": svc_name,
                    "port": port,
                    "note": "Test for XSS"
                })
            
            # FTP with anonymous access
            if svc_name == "ftp":
                opportunities["weak_credentials"].append({
                    "service": svc_name,
                    "port": port,
                    "note": "Try anonymous login"
                })
        
        return opportunities
    
    def generate_exploit_plan(self, opportunities: Dict) -> List[Dict]:
        """
        Generate exploitation plan based on opportunities
        
        Args:
            opportunities: Dictionary of exploitation opportunities
        
        Returns:
            List of exploitation steps
        """
        plan = []
        
        # Prioritize RCE
        for rce in opportunities.get("rce", []):
            plan.append({
                "priority": 1,
                "type": "RCE",
                "target": rce,
                "action": "Exploit CVE",
                "payload": None
            })
        
        # Then SQL injection
        for sqli in opportunities.get("sqli", []):
            plan.append({
                "priority": 2,
                "type": "SQL Injection",
                "target": sqli,
                "action": "Test SQL injection",
                "payload": self.payload_gen.sql_injection("union")
            })
        
        # Command injection
        for cmd in opportunities.get("command_injection", []):
            plan.append({
                "priority": 3,
                "type": "Command Injection",
                "target": cmd,
                "action": "Test command injection",
                "payload": self.payload_gen.command_injection()
            })
        
        # Weak credentials
        for weak in opportunities.get("weak_credentials", []):
            plan.append({
                "priority": 4,
                "type": "Weak Credentials",
                "target": weak,
                "action": "Brute force or default credentials",
                "payload": None
            })
        
        return sorted(plan, key=lambda x: x["priority"])
    
    def display_exploit_plan(self, plan: List[Dict]):
        """Display exploitation plan in a table"""
        table = Table(title="ðŸŽ¯ Exploitation Plan", show_header=True, header_style="bold red")
        table.add_column("Priority", style="cyan", justify="center", width=8)
        table.add_column("Type", style="yellow", width=20)
        table.add_column("Target", style="white", width=30)
        table.add_column("Action", style="green", width=40)
        
        for step in plan:
            priority_emoji = "ðŸ”´" if step["priority"] == 1 else "ðŸŸ " if step["priority"] == 2 else "ðŸŸ¡"
            table.add_row(
                f"{priority_emoji} {step['priority']}",
                step["type"],
                f"{step['target'].get('service', 'N/A')}:{step['target'].get('port', 'N/A')}",
                step["action"]
            )
        
        console.print("\n")
        console.print(table)
        console.print("\n[dim]âš ï¸  Use with caution. Only on authorized targets.[/dim]\n")
    
    def auto_exploit_workflow(self, services: List[Dict]) -> Dict:
        """
        Complete auto-exploitation workflow
        
        Args:
            services: List of discovered services
        
        Returns:
            Exploitation results
        """
        log(Fore.CYAN + "\n[ðŸ¤–] Starting auto-exploitation analysis...", self.log_file)
        
        # Analyze services
        opportunities = self.analyze_services(services)
        
        # Generate plan
        plan = self.generate_exploit_plan(opportunities)
        
        # Display plan
        self.display_exploit_plan(plan)
        
        # Find exploits
        exploits = find_exploits(services, self.report_path, self.log_file)
        
        results = {
            "opportunities": opportunities,
            "plan": plan,
            "exploits": exploits
        }
        
        log(Fore.GREEN + "[âœ”] Auto-exploitation analysis complete.", self.log_file)
        
        return results
