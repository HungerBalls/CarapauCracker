# exploit.py â€” CarapauCracker v2
import re
import subprocess
from typing import List, Dict, Optional
from modules.utils import run_command_live, append_section, log
from colorama import Fore
from modules.exploit_ranker import rank_exploits, display_ranked_exploits, auto_select_exploit


# ================================================================
# ðŸ” SERVICE PARSER (FROM NMAP OUTPUT)
# ================================================================
def parse_nmap_services(nmap_output: str) -> List[Dict]:
    """
    Extract services, ports and versions from Nmap output.
    """
    try:
        services = []
        for line in nmap_output.splitlines():
            match = re.match(r"(\d+)/tcp\s+open\s+(\S+)\s+(.*)", line)
            if match:
                services.append({
                    "port": match.group(1),
                    "service": match.group(2),
                    "version": match.group(3).strip()
                })
        return services
    except Exception as e:
        print(Fore.RED + f"[âœ˜] Error parsing Nmap services: {e}")
        return []


# ================================================================
# ðŸ’¾ SEARCHSPLOIT + PARSING
# ================================================================
def searchsploit_lookup(query: str, report_path, log_file=None) -> List[Dict]:
    """Search for exploits using SearchSploit (Exploit-DB)"""
    try:
        log(Fore.CYAN + f"\n[ðŸ’¾] SearchSploit lookup: {query}", log_file)
        output = run_command_live(["searchsploit", query], log_file)
        
        if output:
            append_section(report_path, f"SearchSploit Results ({query})", output)
        
        results = []
        for line in output.splitlines():
            if "|" in line and not line.startswith("----"):
                parts = line.split("|")
                if len(parts) >= 2:
                    results.append({
                        "title": parts[0].strip(),
                        "path": parts[1].strip()
                    })
        return results
    except FileNotFoundError:
        error_msg = "SearchSploit not found. Install with: sudo apt install exploitdb"
        log(Fore.RED + f"[âœ˜] {error_msg}", log_file)
        return []
    except Exception as e:
        error_msg = f"SearchSploit lookup failed: {str(e)}"
        log(Fore.RED + f"[âœ˜] {error_msg}", log_file)
        return []


# ================================================================
# ðŸ§  CLASSIFICATION AND PRIORITIZATION
# ================================================================
def classify_exploit(title: str) -> str:
    """Classify exploit by type based on title/description"""
    try:
        title = title.lower()
        if "rce" in title or "remote code" in title or "execution" in title:
            return "RCE"
        if "auth" in title or "bypass" in title:
            return "AUTH BYPASS"
        if "privilege" in title or "local" in title:
            return "LPE"
        if "dos" in title or "denial" in title:
            return "DoS"
        return "OTHER"
    except Exception as e:
        print(Fore.RED + f"[âœ˜] Error classifying exploit: {e}")
        return "OTHER"


# ================================================================
# âš™ï¸ CORE ENGINE
# ================================================================
def find_exploits(services: List[Dict], report_path, log_file=None) -> Dict:
    """
    Search for exploits in SearchSploit based on Nmap services.
    """
    try:
        results = {}
        all_exploits = []
        
        for svc in services:
            key = f"{svc['service']} {svc['version']}"
            log(Fore.CYAN + f"\n[ðŸ§©] Analyzing: {key}", log_file)

            ss_exploits = searchsploit_lookup(key, report_path, log_file)
            all_exploits.extend(ss_exploits)

            results[key] = {"searchsploit": ss_exploits}

        # Rank all found exploits
        if all_exploits:
            ranked = rank_exploits(all_exploits, services)
            
            # Display ranked results
            display_ranked_exploits(ranked)
            
            # Auto-select and display best exploit
            auto_select_exploit(ranked)
        
        formatted = format_exploit_report(results)
        append_section(report_path, "Exploit Summary", formatted)
        log(Fore.GREEN + "[âœ”] Exploit search completed.\n", log_file)
        return results
    except Exception as e:
        error_msg = f"Error finding exploits: {str(e)}"
        log(Fore.RED + f"[âœ˜] {error_msg}", log_file)
        return {}


# ================================================================
# ðŸ“„ REPORT FORMATTING
# ================================================================
def format_exploit_report(data: Dict) -> str:
    """Format exploit search results for report"""
    try:
        output = []
        for service, payloads in data.items():
            output.append("=" * 60)
            output.append(f"[ SERVICE ] {service}")

            output.append("\n[SearchSploit]")
            if payloads["searchsploit"]:
                for e in payloads["searchsploit"][:5]:
                    exploit_type = classify_exploit(e.get('title', ''))
                    output.append(f"[{exploit_type}] {e['title']} â†’ {e['path']}")
            else:
                output.append("No results.")
        return "\n".join(output)
    except Exception as e:
        error_msg = f"Error formatting exploit report: {str(e)}"
        print(Fore.RED + f"[âœ˜] {error_msg}")
        return f"Error formatting report: {e}"

